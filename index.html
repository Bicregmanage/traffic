<!DOCTYPE html>
<script src="https://cdn.jsdelivr.net/npm/jose@4.14.4/dist/browser/index.min.js"></script>
<script>
  async function checkAccess() {
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    const idToken = params.get('id_token') || sessionStorage.getItem('id_token');

    if (params.get('id_token')) {
      sessionStorage.setItem('id_token', params.get('id_token'));
      // URL„ÅÆ„Éè„ÉÉ„Ç∑„É•„ÇíÊ∂à„Åô
      history.replaceState(null, null, window.location.pathname);
    }

    if (!idToken) {
      const loginUrl = 'https://us-east-1xfqyhityj.auth.us-east-1.amazoncognito.com/login' +
        '?client_id=67qjddtattdr5i1871723tbtnt' +
        '&response_type=token' +
        '&scope=email+openid' +
        '&redirect_uri=https%3A%2F%2Fbicregmanage.github.io%2Ftraffic%2Findex.html';
      window.location.href = loginUrl;
      return;
    }

    try {
      const { decodeJwt } = jose;
      const payload = decodeJwt(idToken);
      console.log("üë§ Ë™çË®ºÊ∏à„Åø„É¶„Éº„Ç∂„Éº:", payload.email || "(email„Å™„Åó)");
    } catch (e) {
      alert('„Éà„Éº„ÇØ„É≥„ÅÆÊ§úË®º„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„É≠„Ç∞„Ç§„É≥„ÅóÁõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
      sessionStorage.clear();
      window.location.href = '/traffic/index.html';
    }
  }

  checkAccess();
</script>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁôªÈå≤Áï™Âè∑Ê§úÁ¥¢„Ç∑„Çπ„ÉÜ„É†</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background-color: #f0f0f0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            margin: 0; 
        }
        .container { 
            width: 500px; 
            padding: 20px; 
            background-color: #fff; 
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); 
            border-radius: 8px; 
            text-align: center; 
            margin-top: 8%;
        }
        input, textarea { 
            margin: 10px 0; 
            padding: 10px; 
            width: calc(100% - 22px); 
            border: 1px solid #ccc; 
            border-radius: 4px; 
        }
        button { 
            padding: 10px 20px; 
            margin: 10px 5px; 
            border: none; 
            border-radius: 4px; 
            background-color: #007bff; 
            color: white; 
            cursor: pointer; 
        }
        button:hover { 
            background-color: #0056b3; 
        }
        .table-container { 
            max-height: 300px; 
            overflow-y: auto; 
            margin-top: 20px; 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
        }
        th, td { 
            padding: 10px; 
            border: 1px solid #ccc; 
            text-align: left; 
        }
        th { 
            background-color: #f9f9f9; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        .edit-btn { 
            background-color: gray; 
            color: white; 
            border: none; 
            padding: 5px; 
            cursor: pointer; 
            margin-left: 5px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        .edit-btn:hover {
            background-color: gray;
        }
        .sort-btn { 
            background-color: #28a745; 
            color: white; 
            border: none; 
            padding: 5px 10px; 
            cursor: pointer; 
            margin-left: 5px; 
        }
        .sort-btn:hover { 
            background-color: #218838; 
        }
        .name-cell, .memo-cell { 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        @media (max-width: 600px) {
        .controls {
            flex-direction: column;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>ÁôªÈå≤Áï™Âè∑Ê§úÁ¥¢„Ç∑„Çπ„ÉÜ„É†</h2>
        <button onclick="redirectToAdmin()">ÁÆ°ÁêÜËÄÖ„Éö„Éº„Ç∏„Å∏</button>
        <input type="text" id="searchInput" placeholder="Ê§úÁ¥¢ (Áï™Âè∑„Åæ„Åü„ÅØÂêçÂâç)" oninput="searchEntries()">
        <div>
            <select id="sortSelect" onchange="sortTable()">
                <option value="number">Áï™Âè∑„Åß„ÇΩ„Éº„Éà</option>
                <option value="timestamp">ËøΩÂä†Êó•ÊôÇ„Åß„ÇΩ„Éº„Éà</option>
            </select>
            <button class="sort-btn" onclick="toggleSortDirection()">„ÇΩ„Éº„ÉàÈ†ÜÂ∫è„ÇíÂ§âÊõ¥</button>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Áï™Âè∑</th>
                        <th>ÂêçÂâç</th>
                        <th>„É°„É¢</th>
                        <th>ËøΩÂä†Êó•ÊôÇ</th>
                    </tr>
                </thead>
                <tbody id="entryList"></tbody>
            </table>
        </div>
    </div>
    <script>
        function redirectToAdmin() {
          const loginUrl = 'https://us-east-1xfqyhityj.auth.us-east-1.amazoncognito.com/login' +
            '?client_id=67qjddtattdr5i1871723tbtnt' +
            '&response_type=token' +
            '&scope=email+openid' +
            '&redirect_uri=https%3A%2F%2Fbicregmanage.github.io%2Ftraffic%2Fadmin.html';
          window.location.href = loginUrl;
        }
        let sortDirection = true;
    
        document.addEventListener("DOMContentLoaded", loadEntries);
    
        async function loadEntries() {
            try {
                const response = await fetch('https://shqipfhr9d.execute-api.us-east-2.amazonaws.com/entries');
                const data = await response.json();
                window.entries = data;
                renderEntries(data);
            } catch (error) {
                console.error('Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                alert('ÁôªÈå≤Áï™Âè∑„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        }
    
        function renderEntries(data) {
            const entryList = document.getElementById("entryList");
            entryList.innerHTML = "";
            data.forEach(entry => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${entry.number}</td>
                    <td>${entry.name}</td>
                    <td>${entry.memo}</td>
                    <td>${entry.timestamp}</td>
                `;
                entryList.appendChild(tr);
            });
        }
    
        function searchEntries() {
            const keyword = document.getElementById("searchInput").value.toLowerCase();
            const filtered = window.entries.filter(entry =>
                entry.number.includes(keyword) || entry.name.toLowerCase().includes(keyword)
            );
            renderEntries(filtered);
        }
    
        function sortTable() {
            const key = document.getElementById("sortSelect").value;
        
            const sorted = [...window.entries].sort((a, b) => {
                let valA = a[key];
                let valB = b[key];
        
                if (key === "number") {
                    valA = parseInt(valA);
                    valB = parseInt(valB);
                    return sortDirection ? valA - valB : valB - valA;
                } else {
                    return sortDirection
                        ? valA.localeCompare(valB, 'ja')
                        : valB.localeCompare(valA, 'ja');
                }
            });
        
            renderEntries(sorted);
        }

        function toggleSortDirection() {
            sortDirection = !sortDirection;
            sortTable();
        }
    </script>    
</body>
</html>
